# v1.3.1 Task Breakdown

**Milestone**: v1.3.1  
**Target Date**: Late January 2025  
**Branch**: `feat/v1.3.1-applyadapter-benchmarks`  
**Status**: ðŸš§ In Progress

---

## Overview

v1.3.1 completes the LoRA adapter hot-swapping feature and validates streaming performance claims from v1.3.0.

---

## ðŸ“‹ GitHub Issues

### Created Issues

| # | Title | Priority | Estimate | Status |
|---|-------|----------|----------|--------|
| [#49](https://github.com/GarthDB/metal-candle/issues/49) | Implement ApplyAdapter trait | ðŸ”´ Critical | 2-3 weeks | Open |
| [#50](https://github.com/GarthDB/metal-candle/issues/50) | Streaming performance benchmarks | ðŸŸ¡ High | 3-5 days | Open |
| [#51](https://github.com/GarthDB/metal-candle/issues/51) | Performance optimizations | ðŸŸ¢ Medium | 2-3 days | Open |

**Total Estimate**: 3-4 weeks

---

## ðŸŽ¯ Issue #49: ApplyAdapter Implementation

**Priority**: ðŸ”´ Critical (completes v1.3.0 feature)  
**Estimate**: 2-3 weeks

### Subtasks

#### Week 1: Core Implementation
- [ ] Add adapter state tracking to `Qwen2ForSequenceClassification`
  - [ ] Create `AdapterState` struct
  - [ ] Add state field to model
  - [ ] Implement state management methods
  
- [ ] Implement `ApplyAdapter` trait methods
  - [ ] `apply_adapter()` - Load and activate adapter
  - [ ] `remove_adapter()` - Deactivate and unload
  - [ ] `has_adapter()` - Check adapter status
  - [ ] `current_adapter()` - Get active adapter info
  
- [ ] Adapter application for attention layers
  - [ ] Modify Q/K/V projections with LoRA weights
  - [ ] Handle rank and alpha parameters
  - [ ] Ensure proper weight initialization
  
- [ ] Adapter application for MLP layers
  - [ ] Modify gate/up/down projections
  - [ ] Support different LoRA configurations
  
- [ ] Unit tests for each component
  - [ ] Test adapter state management
  - [ ] Test weight application
  - [ ] Test multiple adapters
  - [ ] Test edge cases

#### Week 2: Integration & Testing
- [ ] End-to-end adapter swapping tests
  - [ ] Load base model
  - [ ] Apply first adapter
  - [ ] Generate output
  - [ ] Switch to second adapter
  - [ ] Verify different outputs
  - [ ] Remove adapter
  - [ ] Verify base model behavior
  
- [ ] Memory leak detection
  - [ ] Run instruments profiling
  - [ ] Check for retained adapters
  - [ ] Verify cleanup on removal
  
- [ ] Performance benchmarks
  - [ ] Measure adapter application time
  - [ ] Measure switching time
  - [ ] Compare vs registry approach
  - [ ] Target: <5ms total
  
- [ ] Update `adapter_swap_demo.rs`
  - [ ] Use `ApplyAdapter` directly
  - [ ] Show hot-swapping workflow
  - [ ] Demonstrate performance
  
- [ ] Complete documentation
  - [ ] API docs for trait methods
  - [ ] Usage examples
  - [ ] Performance characteristics
  - [ ] Migration guide from registry-only

### Files to Modify

```
src/models/qwen.rs                   # Implement ApplyAdapter
src/training/apply_adapter.rs        # Update trait docs
tests/training/adapter_hotswap.rs    # Add integration tests
examples/adapter_swap_demo.rs        # Update example
benches/fused_lora_bench.rs         # Add adapter swap bench
CHANGELOG.md                         # Document changes
```

### Success Criteria
- âœ… Models support all `ApplyAdapter` methods
- âœ… Adapter swapping <5ms
- âœ… Zero memory leaks
- âœ… Test coverage â‰¥95%
- âœ… Example demonstrates workflow

---

## ðŸŽ¯ Issue #50: Streaming Benchmarks

**Priority**: ðŸŸ¡ High (validates v1.3.0 claims)  
**Estimate**: 3-5 days

### Subtasks

#### Day 1-2: Benchmark Creation
- [ ] Create `benches/streaming.rs`
- [ ] Implement baseline benchmark (`generate()`)
- [ ] Implement sync streaming (`generate_stream()`)
- [ ] Implement async streaming (`generate_stream_async()`)
- [ ] Configure criterion for consistency
- [ ] Test on M4 Max

#### Day 3: Measurement & Analysis
- [ ] Run benchmarks 5+ times
- [ ] Collect consistent measurements
- [ ] Calculate statistical significance
- [ ] Profile with Instruments.app
- [ ] Identify unexpected overhead
- [ ] Document findings

#### Day 4: Documentation
- [ ] Update CHANGELOG with measurements
- [ ] Add streaming section to BENCHMARKS.md
- [ ] Update API docs with performance notes
- [ ] Create performance comparison table
- [ ] Document caveats and limitations

#### Day 5 (Optional): CI Integration
- [ ] Add to CI workflow
- [ ] Set up baseline tracking
- [ ] Create regression detection
- [ ] Document CI integration

### Files to Create/Modify

```
benches/streaming.rs                 # New benchmark file
CHANGELOG.md                         # Add measurements
BENCHMARKS.md                        # Add streaming section
src/inference/generator.rs           # Add performance notes
docs/STREAMING_PERFORMANCE.md        # Detailed analysis (optional)
```

### Success Criteria
- âœ… Comprehensive benchmark suite
- âœ… Streaming overhead <5% (or documented)
- âœ… Async overhead <10% (or documented)
- âœ… Results integrated into docs
- âœ… Profiling completed

### Expected Results

```
Benchmark Results (Target):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
generate() [baseline]:      1000 tokens in 2.50s (400 tok/s)
generate_stream() [sync]:   1000 tokens in 2.60s (385 tok/s) [+4%]
generate_stream_async():    1000 tokens in 2.65s (377 tok/s) [+6%]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ðŸŽ¯ Issue #51: Performance Optimizations

**Priority**: ðŸŸ¢ Medium (conditional)  
**Estimate**: 2-3 days  
**Depends On**: Issues #49 and #50

### Conditional Execution

âš ï¸ **Only work on this if**:
- Streaming overhead >5%
- Adapter switching >5ms
- Profiling shows clear bottlenecks

### Potential Optimization Areas

#### 1. Streaming Path
- [ ] Reduce `StreamToken` allocations
- [ ] Cache tokenizer decoding
- [ ] Optimize probability calculations
- [ ] Use `SmallVec` for stack allocation

#### 2. Adapter Switching
- [ ] Pre-allocate adapter buffers
- [ ] Batch adapter application
- [ ] Reduce GPU synchronization
- [ ] Cache adapter state

#### 3. Memory Management
- [ ] Object pools for tensors
- [ ] Explicit `drop()` for large objects
- [ ] Arena allocation
- [ ] Reduce clones

#### 4. Metal GPU
- [ ] Optimize threadgroup sizes
- [ ] Batch operations
- [ ] Async compute overlap
- [ ] Profile with Metal System Trace

### Subtasks

#### Day 1: Analysis
- [ ] Review benchmark results
- [ ] Analyze profiling data
- [ ] Identify top bottlenecks
- [ ] Estimate impact
- [ ] Prioritize optimizations

#### Day 2: Implementation
- [ ] Implement high-priority optimizations
- [ ] Add micro-benchmarks
- [ ] Verify improvements
- [ ] Ensure no regressions
- [ ] Code review

#### Day 3: Documentation
- [ ] Document techniques used
- [ ] Update performance docs
- [ ] Add code comments
- [ ] Update CHANGELOG

### Files to Modify (TBD)

Depends on optimization areas:
```
src/inference/generator.rs           # Streaming optimizations
src/inference/sampling.rs            # Token generation
src/models/qwen.rs                  # Adapter application
src/training/adapter_registry.rs     # Registry optimizations
src/backend/metal_ops.rs            # Metal kernels
```

### Success Criteria
- âœ… Streaming overhead <5%
- âœ… Adapter switching <5ms
- âœ… No regressions
- âœ… Code quality maintained
- âœ… Tests passing

---

## ðŸ“… Timeline

### Week 1 (Jan 1-5)
- [ ] Start Issue #49: ApplyAdapter core implementation
- [ ] Design adapter state management
- [ ] Implement trait methods

### Week 2 (Jan 6-12)
- [ ] Continue Issue #49: Integration and testing
- [ ] Start Issue #50: Create streaming benchmarks
- [ ] Initial benchmark runs

### Week 3 (Jan 13-19)
- [ ] Complete Issue #49: Documentation and polish
- [ ] Complete Issue #50: Analysis and documentation
- [ ] Evaluate need for Issue #51

### Week 4 (Jan 20-26)
- [ ] (Conditional) Issue #51: Performance optimizations
- [ ] Final testing and integration
- [ ] Update all documentation
- [ ] Prepare release

### Week 5 (Jan 27-31)
- [ ] Release candidate testing
- [ ] Final benchmarks
- [ ] Release v1.3.1

---

## ðŸ”— Dependencies

### Issue Dependencies
```
#49 (ApplyAdapter) â”€â”€â”¬â”€â”€> Can be developed in parallel
                     â”‚
#50 (Benchmarks) â”€â”€â”€â”€â”¤
                     â”‚
                     â””â”€â”€> #51 (Optimizations)
                          [Only if needed]
```

### External Dependencies
- Test models for benchmarking
- M4 Max hardware for accurate measurements
- Profiling tools (Instruments.app)

---

## ðŸŽ¯ Success Criteria (Overall)

### Functionality
- âœ… Full `ApplyAdapter` implementation on models
- âœ… Hot-swap adapters without model reload
- âœ… Comprehensive benchmarks for streaming

### Performance
- âœ… Adapter swapping <5ms
- âœ… Streaming overhead <5%
- âœ… No regressions vs v1.3.0

### Quality
- âœ… Test coverage â‰¥95% for new code
- âœ… Zero clippy warnings
- âœ… Complete documentation
- âœ… All examples working

### Documentation
- âœ… API docs complete
- âœ… Performance data validated
- âœ… Migration guide updated
- âœ… CHANGELOG comprehensive

---

## ðŸ“Š Progress Tracking

### Overall Progress: 0/3 issues complete

| Issue | Status | Progress | Blocked |
|-------|--------|----------|---------|
| #49 | ðŸŸ¡ Open | 0% | No |
| #50 | ðŸŸ¡ Open | 0% | No |
| #51 | ðŸŸ¡ Open | 0% | Yes (#49, #50) |

### Week-by-Week Goals

**Week 1**: 25% complete (#49 core impl)  
**Week 2**: 50% complete (#49 integration, #50 started)  
**Week 3**: 75% complete (#49 done, #50 done)  
**Week 4**: 90% complete (#51 if needed)  
**Week 5**: 100% complete (release)

---

## ðŸ”§ Development Setup

### Branch
```bash
git checkout feat/v1.3.1-applyadapter-benchmarks
```

### Run Tests
```bash
cargo test
cargo test --features streaming  # For async tests
```

### Run Benchmarks
```bash
cargo bench --bench streaming        # Streaming benchmarks
cargo bench --bench fused_lora_bench # Adapter benchmarks
cargo bench                          # All benchmarks
```

### Profile
```bash
cargo instruments -t Time --release --example adapter_swap_demo
cargo instruments -t Allocations --release --example streaming_demo
```

---

## ðŸ“ Commit Strategy

### Commit Message Format
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Examples
```
feat(adapters): implement ApplyAdapter for Qwen2
perf(streaming): reduce StreamToken allocations
test(adapters): add hot-swap integration tests
docs(streaming): add performance benchmarks
```

### PR Strategy
- Option 1: Single PR for v1.3.1 (all issues)
- Option 2: Separate PRs per issue
- Recommended: Separate PRs for better review

---

## ðŸŽŠ Release Checklist

When all issues complete:

- [ ] All tests passing
- [ ] All benchmarks run and documented
- [ ] Coverage â‰¥80%
- [ ] Zero clippy warnings
- [ ] Documentation complete
- [ ] CHANGELOG updated with date
- [ ] Examples tested manually
- [ ] Release notes drafted
- [ ] Tag v1.3.1
- [ ] Create GitHub release
- [ ] Announce on socials

---

## ðŸ”— Quick Links

- **Milestone**: [v1.3.1](https://github.com/GarthDB/metal-candle/milestone/1)
- **Issue #49**: [ApplyAdapter](https://github.com/GarthDB/metal-candle/issues/49)
- **Issue #50**: [Streaming Benchmarks](https://github.com/GarthDB/metal-candle/issues/50)
- **Issue #51**: [Performance Optimizations](https://github.com/GarthDB/metal-candle/issues/51)
- **Project Board**: [v1.3+ Roadmap](https://github.com/users/GarthDB/projects/3)
- **Branch**: `feat/v1.3.1-applyadapter-benchmarks`

---

**Created**: December 18, 2024  
**Target Release**: Late January 2025  
**Last Updated**: December 18, 2024

