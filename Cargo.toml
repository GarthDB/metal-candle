[package]
name = "metal-candle"
version = "1.2.2"
edition = "2021"
rust-version = "1.75"
authors = ["Garth Braithwaite <garthdb@gmail.com>"]
description = "Production-quality Rust ML crate for Apple Silicon - LoRA training, inference, and text generation using Candle with Metal backend"
repository = "https://github.com/GarthDB/metal-candle"
homepage = "https://github.com/GarthDB/metal-candle"
documentation = "https://docs.rs/metal-candle"
license = "Apache-2.0"
keywords = ["machine-learning", "metal", "lora", "apple-silicon", "transformer"]
categories = ["science", "algorithms"]
readme = "README.md"

[package.metadata.docs.rs]
# docs.rs builds on Linux, so we can't use Metal-specific features (custom-metal)
# Build with embeddings and graph features to show complete API except Metal internals
default-features = false
features = ["embeddings", "graph"]
rustdoc-args = ["--cfg", "docsrs"]

[dependencies]
# Candle - ML framework with Metal backend
# Note: Metal features are available but docs.rs builds without them (Linux)
candle-core = { version = "0.9", features = ["metal"], optional = false }
candle-nn = "0.9"
candle-transformers = "0.9"
candle-metal-kernels = { version = "0.9", optional = true }

# Model formats
safetensors = "0.4"
tokenizers = { version = "0.20", default-features = false, features = ["onig"] }

# HuggingFace Hub integration (for model downloads)
hf-hub = "0.4"

# System paths
dirs = "5.0"

# Serialization
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# Error handling
thiserror = "1.0"

# Logging
tracing = "0.1"

# Random number generation
rand = "0.8"

# Async runtime (for Phase 5)
tokio = { version = "1.0", features = ["rt", "sync", "macros"], optional = true }
async-trait = { version = "0.1", optional = true }

# Lock-free data structures (for Phase 5)
dashmap = { version = "5.5", optional = true }

# Custom Metal kernels (for performance optimization)
# Must match candle-core's metal version (0.27)
metal = { version = "0.27", optional = true }
objc = { version = "0.2", optional = true }

[dev-dependencies]
# Benchmarking
criterion = { version = "0.5", features = ["html_reports"] }

# Testing utilities
approx = "0.5"
proptest = "1.0"
insta = { version = "1.34", features = ["yaml"] }
tempfile = "3.0"

# Examples only (anyhow for examples, never in library code)
anyhow = "1.0"

[features]
default = ["custom-metal", "graph"]
custom-metal = ["dep:metal", "dep:objc", "dep:candle-metal-kernels"]
embeddings = []
graph = []  # Lazy evaluation framework (v2.0+)
async-exec = ["graph", "dep:tokio", "dep:async-trait", "dep:dashmap"]  # Async execution (Phase 5)

[lints.rust]
unsafe_code = "deny"  # Deny by default, but allow MPS module to opt-in with #![allow]
missing_docs = "warn"

[lints.clippy]
# Strict pedantic linting (not nursery - too unstable)
pedantic = { level = "deny", priority = -1 }

# Cargo lints
cargo = { level = "warn", priority = -1 }

# Deny these specific lint groups
all = { level = "deny", priority = -1 }
correctness = { level = "deny", priority = -1 }
suspicious = { level = "deny", priority = -1 }
complexity = { level = "deny", priority = -1 }
perf = { level = "deny", priority = -1 }

# Allow specific pedantic lints where necessary (priority 0 overrides deny at -1)
module_name_repetitions = { level = "allow", priority = 0 }  # Common in Rust for clear module organization
multiple_crate_versions = { level = "allow", priority = 0 }  # Transitive dependencies from Candle
doc_markdown = { level = "allow", priority = 0 }  # Backtick requirements are overly strict for technical terms
missing_panics_doc = { level = "allow", priority = 0 }  # Documented where critical; internal panics are intentional
uninlined_format_args = { level = "allow", priority = 0 }  # Format string style preference
redundant_closure = { level = "allow", priority = 0 }  # Sometimes more readable
too_many_lines = { level = "allow", priority = 0 }  # Complex functions sometimes necessary in ML code
items_after_statements = { level = "allow", priority = 0 }  # Rust style preference, not correctness issue
cast_precision_loss = { level = "allow", priority = 0 }  # Common and justified in ML code (dims, batch sizes)
missing_fields_in_debug = { level = "allow", priority = 0 }  # Intentional for custom debug formatting
doc_link_with_quotes = { level = "allow", priority = 0 }  # Documentation style preference

[profile.release]
opt-level = 3
lto = "thin"
codegen-units = 1

[profile.bench]
inherits = "release"

[[bench]]
name = "training"
harness = false

[[bench]]
name = "inference"
harness = false

[[bench]]
name = "mlx_comparison"
harness = false

[[bench]]
name = "fused_lora_bench"
harness = false

[[bench]]
name = "lazy_vs_eager"
harness = false

